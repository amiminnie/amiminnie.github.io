<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>amiminnie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#111111" />
    <link id="theme-style" rel="stylesheet" href="light.css" />
    <link id="style" rel="stylesheet" href="style.css" />
    <link rel="icon" href="images/favicon.ico" />
  </head>

  <body>
    <div class="container">
      <header>
        <nav>
          <a href="" class="active">about</a>
          <a href="gallery.html">gallery</a>
          <a href="hobbies.html">hobbies</a>
          <button id="theme-toggle" class="theme-btn" title="Dark mode extensions may interfere with this!">
            <img id="theme-icon" src="images/moon-icon.png" alt="Toggle theme" />
          </button>
        </nav>
      </header>

      <main>
        <section class="intro">
          <p class="prefix">am i</p>
          <h1>Minnie?</h1>
          <p class="subtitle">artist ⁘ developer</p>

          <div class="bio">
            <p>i sometimes make web-comics</p>
            <p>i'm working on a game, haven't thought of a name though</p>
            <p>i like <a href="https://geotastic.net" target="_blank" rel="noopener noreferrer">geotastic</a></p>
          </div>
        </section>

        <section class="guestbook">
          <h2>leave a comment!</h2>

          <form id="guestbook-form">
            <input type="text" id="name" placeholder="nickname (optional)" />
            <textarea id="message" placeholder="what do you think?" required></textarea>
            <button type="submit">Send</button>
          </form>

          <div id="guestbook-entries">
            <p>loading what others have to say…</p>
          </div>
        </section>
        <div class="social-wrapper">
          <section class="friends-list">
            <p class="prefixa">these are my</p>
            <h1>friends!</h1>
            <a class="friends-item" href="https://s4qc.github.io" target="_blank" rel="noopener noreferrer">
              <img src="images/logos/s4qc.png" alt="S4qC" />
              <div class="friends-text">
                <h2>S4qC</h2>
                <p>don't ask him why he stopped using linux</p>
              </div>
            </a>
            <div class="friends-item">
              <img src="images/logos/coffee-fueled-student.jpeg" alt="Coffee feuled student" />
              <div class="friends-text">
                <h2>coffee_fueled_student</h2>
                <p>hide the coffee</p>
              </div>
            </div>
            <div class="friends-item">
              <img src="images/logos/lucy.png" alt="Coffee feuled student" />
              <div class="friends-text">
                <h2>Lucy</h2>
                <p>hope everything works out for them</p>
              </div>
            </div>
          </section>

          <section class="social-list">
            <p class="prefixa">check out my</p>
            <h1>socials</h1>
            <a class="social-item" href="https://discord.gg/HHTfSyZyKy" target="_blank" rel="noopener noreferrer">
              <img src="images/logos/discord.png" alt="Discord" />
              <div class="social-text">
                <h2>Discord</h2>
                <p>@amiminnie - add me as a friend</p>
              </div>
            </a>

            <a
              class="social-item"
              href="https://www.reddit.com/user/amiminnie/"
              target="_blank"
              rel="noopener noreferrer">
              <img src="images/logos/reddit.png" alt="Reddit" />
              <div class="social-text">
                <h2>Reddit</h2>
                <p>r/amiminnie - don't check my post history</p>
              </div>
            </a>

            <a class="social-item" href="https://twitter.com/amiminnie1" target="_blank" rel="noopener noreferrer">
              <img src="images/logos/twitter.png" alt="Twitter" />
              <div class="social-text">
                <h2>Twitter</h2>
                <p>@amiminnie1 - i refuse to call it X</p>
              </div>
            </a>

            <a
              class="social-item"
              href="https://ibispaint.com/artist4/7838197604469341/"
              target="_blank"
              rel="noopener noreferrer">
              <img src="images/logos/ibis-paint.png" alt="Twitter" />
              <div class="social-text">
                <h2>ibisPaint</h2>
                <p>Minnie - watch me draw on ibisPaint</p>
              </div>
            </a>
          </section>
        </div>
      </main>

      <footer>
        <p>amiminnie</p>
        <p>
          comments are hosted by <a href="https://supabase.com" target="_blank" rel="noopener noreferrer">Supabase</a>
        </p>
      </footer>
    </div>

    <script>
      const themeLink = document.getElementById("theme-style");
      const toggleBtn = document.getElementById("theme-toggle");
      const themeIcon = document.getElementById("theme-icon");

      const savedTheme = localStorage.getItem("theme");
      const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

      function setTheme(mode) {
        if (mode === "dark") {
          themeLink.href = "dark.css";
          document.documentElement.style.colorScheme = "dark";
          themeIcon.src = "images/sun-icon.png";
          themeIcon.alt = "light mode";
          localStorage.setItem("theme", "dark");
        } else {
          themeLink.href = "light.css";
          document.documentElement.style.colorScheme = "light";
          themeIcon.src = "images/moon-icon.png";
          themeIcon.alt = "dark mode";
          localStorage.setItem("theme", "light");
        }
      }

      // Initial load
      if (savedTheme) {
        setTheme(savedTheme);
      } else if (systemPrefersDark) {
        setTheme("dark");
      } else {
        setTheme("light");
      }

      // Toggle click
      toggleBtn.addEventListener("click", () => {
        themeIcon.style.transform = "scale(0)";
        setTimeout(() => {
          const current = localStorage.getItem("theme");
          setTheme(current === "dark" ? "light" : "dark");
          void themeIcon.offsetWidth; // force reflow
          themeIcon.style.transform = "scale(1)";
        }, 120);
      });
    </script>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      // Supabase config
      const SUPABASE_URL = "https://miwcmqwhudshgetmrmhf.supabase.co";
      const SUPABASE_KEY = "sb_publishable_stheDa15dO1UIajFAVSHmw_hKuIf4GZ";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Elements
      const guestbookForm = document.getElementById("guestbook-form");
      const guestbookEntries = document.getElementById("guestbook-entries");

      // Load existing messages
      async function loadMessages() {
        try {
          const { data, error } = await supabase
            .from("guestbook")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          guestbookEntries.innerHTML = "";

          if (!data.length) {
            guestbookEntries.innerHTML = "<p>aww nothing :(</p>";
            return;
          }
          data.forEach((msg) => {
            const div = document.createElement("div");
            div.className = "guestbook-entry";

            div.innerHTML = `
                    <div class="guestbook-entry-header" style="display: flex; justify-content: space-between; align-items: baseline;">
                        <strong>${msg.name}</strong>
                        <small style="color: var(--text-muted); font-size: 0.75rem;">
                            ${new Date(msg.created_at).toLocaleDateString({
                              day: "numeric",
                              month: "short",
                              year: "numeric"
                            })} - ${new Date(msg.created_at).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
                        </small>
                    </div>
                    <p>${msg.message}</p>
                `;

            // If reply exists, add it under the message, slightly indented
            if (msg.reply) {
              const replyDiv = document.createElement("div");
              replyDiv.className = "guestbook-reply";
              replyDiv.style.marginLeft = "1.5rem"; // indent
              replyDiv.style.borderLeft = "2px solid var(--border-solid)"; // optional visual
              replyDiv.style.paddingLeft = "0.5rem";
              replyDiv.style.marginTop = "0.25rem";
              replyDiv.innerHTML = `<strong> Minnie:</strong> <span>${msg.reply}</span>`;
              div.appendChild(replyDiv);
            }

            guestbookEntries.appendChild(div);
          });
        } catch (err) {
          guestbookEntries.innerHTML = `<p>idk, they say ${err.message} happened :/</p>`;
          console.error(err);
        }
      }

      // Submit new message
      // Helper function to strip HTML special characters
      const escapeHTML = (str) => {
        return str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;"
            })[m]
        );
      };

      guestbookForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        let rawName = document.getElementById("name").value.trim();
        const rawMessage = document.getElementById("message").value.trim();

        if (!rawMessage) return;

        // Block if the message contains the forbidden character
        if (rawName.includes("✿")) {
          alert("hehe cheeky fella, verification badge is for my close friends!");
          return;
        }

        // Sanitize the inputs
        const name = rawName ? escapeHTML(rawName) : "anonymous";
        const message = escapeHTML(rawMessage);

        try {
          const { error } = await supabase.from("guestbook").insert([{ name, message }]);

          if (error) throw error;

          guestbookForm.reset();
          loadMessages();
        } catch (err) {
          alert("sorry, something happened: " + err.message);
          console.error(err);
        }
      });

      // Initial load
      loadMessages();

      document.querySelectorAll(".friends-item").forEach((item) => {
        const img = item.querySelector("img");
        if (!img) return;

        item.addEventListener("mouseenter", () => {
          spawnHeartsFromImage(img);
        });
      });

      function spawnHeartsFromImage(img) {
        const rect = img.getBoundingClientRect();

        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        for (let i = 0; i < 12; i++) {
          const heart = document.createElement("img");
          heart.src = "images/heart.png";
          heart.className = "heart-particle";

          heart.style.left = `${centerX}px`;
          heart.style.top = `${centerY}px`;

          const angle = Math.random() * Math.PI * 2;
          const distance = 50 + Math.random() * 20;

          const x = Math.cos(angle) * distance;
          const y = Math.sin(angle) * distance;

          heart.style.setProperty("--x", `${x}px`);
          heart.style.setProperty("--y", `${y}px`);

          document.body.appendChild(heart);

          setTimeout(() => {
            heart.remove();
          }, 800);
        }
      }
    </script>
  </body>
</html>
